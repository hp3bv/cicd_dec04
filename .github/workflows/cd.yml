# In .github/workflows/cd.yml
name: CD

on:
  # 1. Use workflow_run instead of push
  workflow_run:
    # Trigger only when the workflow with this EXACT name completes
    workflows: ["CI (Test and Build Artifact)"] 
    types: 
      - completed
    # Trigger only if the CI workflow ran against the 'main' branch
    branches:
      - main 

jobs:
  Download-and-Deploy:
    # Condition: Only run if the triggering CI workflow was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      # ... (environment details)
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Use the specialized action to download from a prior workflow run
      - name: Download Artifact from CI Run
        # This action supports downloading artifacts from other workflow runs.
        uses: dawidd6/action-download-artifact@v3 
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Provide the name of the artifact to download
          name: coverage-artifact 
          # Provide the ID of the run that triggered this workflow
          run_id: ${{ github.event.workflow_run.id }} 
          # Download to the expected path
          path: ./sites 
          
      # 3. Use the downloaded artifact to deploy to GitHub Pages
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./sites

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
